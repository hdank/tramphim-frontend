---
import { capitalizeWords, cleanhtml } from "../utils/movieUtils";

const {
  tenPhim,
  tenKhac,
  currentEpisode,
  currentType,
  thumbnail,
  slug,
  mota,
} = Astro.props;

const siteName = "Trạm Phim";
const siteUrl = Astro.url.origin;
const canonical = Astro.url.href;

const name = capitalizeWords(tenPhim);
const originName = capitalizeWords(tenKhac);
const episode = currentEpisode || "1";
const language =
  currentType === "vietsub"
    ? "Vietsub"
    : currentType === "thuyetminh"
    ? "Thuyết Minh"
    : capitalizeWords(currentType);

const description = cleanhtml(mota || "");
const poster = thumbnail || `${siteUrl}/thumb_web.png`;
const seriesUrl = `${siteUrl}/phim/${slug}`;

const pageTitle = `Phim ${name} | ${originName} ${episode} ${language} HD - ${siteName}`;

function truncate(text, max = 350) {
  if (!text) return "";
  return text.length > max ? text.slice(0, max).trim() + "[…]" : text;
}

const metaDescription = truncate(
  description
    ? `Xem ${name} ${episode} ${language} mới nhất tại ${siteName}. Nội dung phim : ${description}`
    : `Xem ${name} - ${episode} (${language}) tại ${siteName}.`
);

const fullSchema = {
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": "Episode",
      "@id": `${canonical}#episode`,
      name: `${name} - ${episode} (${language})`,
      description: metaDescription,
      episodeNumber: parseInt(episode.replace(/\D/g, "")) || 1,
      partOfSeries: {
        "@type": "TVSeries",
        name,
        url: seriesUrl,
      },
      url: canonical,
      image: poster,
      uploadDate: new Date().toISOString(),
      publisher: {
        "@type": "Organization",
        name: siteName,
        logo: { "@type": "ImageObject", url: `${siteUrl}/thumb_web.png` },
      },
    },
    {
      "@type": "VideoObject",
      "@id": `${canonical}#video`,
      name: `${name} - ${episode} (${language})`,
      description: metaDescription,
      thumbnailUrl: [poster],
      embedUrl: canonical,
      contentUrl: canonical,
      uploadDate: new Date().toISOString(),
      publisher: {
        "@type": "Organization",
        name: siteName,
        logo: { "@type": "ImageObject", url: `${siteUrl}/thumb_web.png` },
      },
    },
    {
      "@type": "BreadcrumbList",
      "@id": `${canonical}#breadcrumb`,
      itemListElement: [
        { "@type": "ListItem", position: 1, name: "Trang chủ", item: siteUrl },
        { "@type": "ListItem", position: 2, name, item: seriesUrl },
        {
          "@type": "ListItem",
          position: 3,
          name: `${episode} ${language}`,
          item: canonical,
        },
      ],
    },
  ],
};
---
<title>{pageTitle}</title>
<meta name="description" content={metaDescription} />
<meta name="robots" content="index, follow" />
<link rel="canonical" href={canonical} />
<link rel="icon" href={`${siteUrl}/favicon.ico`} />

<!-- Open Graph -->
<meta property="og:type" content="video.episode" />
<meta property="og:title" content={pageTitle} />
<meta property="og:description" content={metaDescription} />
<meta property="og:image" content={poster} />
<meta property="og:url" content={canonical} />
<meta property="og:site_name" content={siteName} />
<meta property="og:locale" content="vi_VN" />

<!-- Twitter Card -->
<meta name="twitter:card" content="player" />
<meta name="twitter:title" content={pageTitle} />
<meta name="twitter:description" content={metaDescription} />
<meta name="twitter:image" content={poster} />
<meta name="twitter:player" content={canonical} />

<!-- JSON-LD -->
<script type="application/ld+json" set:html={JSON.stringify(fullSchema)} />
