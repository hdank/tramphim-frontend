import{j as t}from"./jsx-runtime.D_zvdyIk.js";import{R as V,r as o}from"./index.Be8AcK8B.js";import{u as O}from"./AuthProvider.DtbN1DVM.js";import{y as a}from"./index.ujdCixWl.js";const k="https://api.tramphim.com",M=V.memo((({parentId:e,isSubmitting:n,onSubmit:s,onCancel:i})=>{const[r,l]=o.useState(""),c=o.useRef(null);o.useEffect((()=>{c.current?.focus()}),[e]);return t.jsxs("form",{onSubmit:async e=>{e.preventDefault();const t=r.trim();t?await s(t,(()=>l(""))):a.error("Vui lòng nhập nội dung trả lời")},className:"mt-3",children:[t.jsx("textarea",{ref:c,value:r,onChange:e=>l(e.target.value),placeholder:"Viết trả lời...",className:"w-full px-3 py-2 rounded-lg bg-white/5 border border-white/10 text-white text-sm placeholder-gray-500 focus:outline-none focus:border-sky-400 resize-none",rows:"2"}),t.jsxs("div",{className:"flex gap-2 mt-2",children:[t.jsx("button",{type:"submit",disabled:n,className:"px-4 py-1 bg-sky-400 text-white rounded text-sm font-medium hover:bg-sky-500 transition-colors disabled:opacity-50",children:n?"Đang gửi...":"Gửi"}),t.jsx("button",{type:"button",onClick:()=>{l(""),i?.()},className:"px-4 py-1 bg-white/10 text-gray-300 rounded text-sm font-medium hover:bg-white/20 transition-colors",children:"Hủy"})]})]})})),U=({slug:e})=>{const{user:n}=O(),[s,i]=o.useState([]),[r,l]=o.useState(!0),[c,d]=o.useState(!1),[h,u]=o.useState(""),[m,g]=o.useState(null),[x,b]=o.useState({}),[p,f]=o.useState(!1),y=o.useCallback((async()=>{l(!0);try{const t=await fetch(`${k}/api/binhluan/phim/${e}/`);if(t.ok){const e=await t.json();i(e)}else console.error("Failed to fetch comments")}catch(e){console.error("Error fetching comments:",e)}finally{l(!1)}}),[e]);o.useEffect((()=>{f(!0),y()}),[y]),o.useEffect((()=>{const e=()=>{const e=window.location.hash;if(e&&s.length>0){const t=e.substring(1).replace("binh_luan_",""),n=s.find((e=>e.id===t)),i=(t=0)=>{const s=document.getElementById(e.substring(1));s?(s.scrollIntoView({behavior:"smooth",block:"center"}),s.classList.add("ring-2","ring-sky-400","bg-white/10"),setTimeout((()=>{s.classList.remove("ring-2","ring-sky-400","bg-white/10")}),3e3)):t<15&&(0===t&&n&&n.parent_id&&b((e=>({...e,[n.parent_id]:!0}))),setTimeout((()=>i(t+1)),400))};i()}};e();const t=()=>e();return window.addEventListener("hashchange",t),()=>window.removeEventListener("hashchange",t)}),[s]);const w=e=>{const t=new Date(e),n=Math.floor((new Date-t)/1e3),s=Math.floor(n/60),i=Math.floor(s/60),r=Math.floor(i/24);return n<60?"Vừa xong":s<60?`${s} phút trước`:i<24?`${i} giờ trước`:r<7?`${r} ngày trước`:t.toLocaleDateString("vi-VN")},j=({comment:r,allComments:o,isReply:l=!1})=>{const h=o?.filter((e=>e.parent_id===r.id))||[];return t.jsxs("div",{className:"flex gap-3 "+(l?"ml-8":"mb-6"),id:`binh_luan_${r.id}`,children:[t.jsx("div",{className:"flex-shrink-0",children:r.nguoi_dung?.anh_dai_dien_url?t.jsx("img",{src:r.nguoi_dung.anh_dai_dien_url,alt:r.nguoi_dung.username,className:"w-10 h-10 rounded-full object-cover ring-2 ring-white/10"}):t.jsx("div",{className:"w-10 h-10 rounded-full bg-gradient-to-br from-blue-400 to-purple-500 flex items-center justify-center text-white font-semibold",children:r.nguoi_dung?.username?.charAt(0).toUpperCase()})}),t.jsxs("div",{className:"flex-1",children:[t.jsxs("div",{className:"bg-white/5 rounded-lg p-3",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("span",{className:"font-medium text-white",children:r.nguoi_dung?.username}),t.jsx("span",{className:"text-xs text-gray-400",children:w(r.thoi_gian)})]}),t.jsx("p",{className:"text-sm text-gray-200 mt-2 break-words",children:r.noi_dung})]}),t.jsxs("div",{className:"flex gap-2 mt-2",children:[!l&&t.jsx("button",{onClick:()=>g(r.id),className:"text-xs text-gray-400 hover:text-sky-300 transition-colors",children:"Trả lời"}),n&&n.id===r.nguoi_dung.id&&t.jsx("button",{onClick:()=>(async e=>{if(window.confirm("Bạn có chắc muốn xóa bình luận này? Hành động này không thể hoàn tác."))try{const t=localStorage.getItem("access_token"),n=await fetch(`${k}/api/binhluan/${e}/`,{method:"DELETE",headers:{Authorization:`Bearer ${t}`}});if(n.ok)i(s.filter((t=>t.id!==e))),a.success("Xóa bình luận thành công!");else{const e=await n.json();a.error(e.detail||"Lỗi khi xóa bình luận")}}catch(e){console.error("Error deleting comment:",e),a.error("Lỗi khi xóa bình luận")}})(r.id),className:"text-xs text-gray-400 hover:text-red-400 transition-colors",children:"Xóa"})]}),m===r.id&&t.jsx(M,{parentId:r.id,isSubmitting:c,onSubmit:(t,s)=>(async(t,s,i)=>{if(n){d(!0);try{const n=localStorage.getItem("access_token"),r=await fetch(`${k}/api/binhluan/add/`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`},body:JSON.stringify({slug:e,noi_dung:s,parent:t})});if(r.ok)await y(),g(null),i?.(),a.success("Trả lời đã được thêm!");else{const e=await r.text();if(console.error("API error response:",e),500===r.status)setTimeout((async()=>{await y(),g(null),i?.(),a.success("Trả lời đã được thêm!")}),500);else try{const t=JSON.parse(e);a.error(t.detail||"Lỗi khi thêm trả lời")}catch{a.error(`Lỗi ${r.status}: ${e||"Lỗi khi thêm trả lời"}`)}}}catch(e){console.error("Error submitting reply:",e),e.message&&(e.message.includes("CORS")||e.message.includes("Failed to fetch"))?setTimeout((async()=>{await y(),g(null),i?.()}),500):a.error("Lỗi khi gửi trả lời")}finally{d(!1)}}else a.error("Vui lòng đăng nhập để trả lời")})(r.id,t,(()=>{s()})),onCancel:()=>g(null)}),h.length>0&&t.jsxs("div",{className:"mt-4",children:[t.jsx("button",{onClick:()=>(e=>{b((t=>({...t,[e]:!t[e]})))})(r.id),className:"text-xs text-gray-400 hover:text-sky-300 transition-colors",children:x[r.id]?"Ẩn trả lời":`Xem ${h.length} trả lời`}),x[r.id]&&t.jsx("div",{className:"mt-3 space-y-3",children:h.map((e=>t.jsx(j,{comment:e,allComments:o,isReply:!0},e.id)))})]})]})]})},N=s.filter((e=>!e.parent_id));return t.jsxs("div",{className:"w-full max-w-4xl mx-auto rounded-lg bg-white/5 p-6 border border-white/10",children:[t.jsx("h2",{className:"text-lg font-semibold text-white mb-6",children:"Bình Luận"}),p?n?t.jsx("form",{onSubmit:async t=>{if(t.preventDefault(),n)if(h.trim()){d(!0);try{const t=localStorage.getItem("access_token"),n=await fetch(`${k}/api/binhluan/add/`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({slug:e,noi_dung:h,parent:null})});if(n.ok){const e=await n.json();e.parent_id||i([e,...s]),u(""),a.success("Bình luận đã được thêm!")}else{const e=await n.text();if(console.error("API error response:",e),500===n.status)setTimeout((async()=>{await y(),u(""),a.success("Bình luận đã được thêm!")}),500);else try{const t=JSON.parse(e);a.error(t.detail||"Lỗi khi thêm bình luận")}catch{a.error(`Lỗi ${n.status}: ${e||"Lỗi khi thêm bình luận"}`)}}}catch(e){console.error("Error submitting comment:",e),e.message&&(e.message.includes("CORS")||e.message.includes("Failed to fetch"))?setTimeout((()=>y()),500):a.error("Lỗi khi gửi bình luận")}finally{d(!1)}}else a.error("Vui lòng nhập bình luận");else a.error("Vui lòng đăng nhập để bình luận")},className:"mb-8",children:t.jsxs("div",{className:"flex gap-3",children:[t.jsx("div",{className:"flex-shrink-0",children:n.anh_dai_dien_url?t.jsx("img",{src:n.anh_dai_dien_url,alt:n.username,className:"w-10 h-10 rounded-full object-cover ring-2 ring-white/10"}):t.jsx("div",{className:"w-10 h-10 rounded-full bg-gradient-to-br from-blue-400 to-purple-500 flex items-center justify-center text-white font-semibold",children:n.username?.charAt(0).toUpperCase()})}),t.jsxs("div",{className:"flex-1",children:[t.jsx("textarea",{value:h,onChange:e=>u(e.target.value),placeholder:"Chia sẻ ý kiến của bạn...",className:"w-full px-4 py-3 rounded-lg bg-white/5 border border-white/10 text-white placeholder-gray-500 focus:outline-none focus:border-sky-400 resize-none",rows:"3"}),t.jsx("div",{className:"flex justify-end mt-3",children:t.jsx("button",{type:"submit",disabled:c||!h.trim(),className:"px-6 py-2 bg-sky-400 text-white rounded-lg font-medium hover:bg-sky-500 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:c?"Đang gửi...":"Bình luận"})})]})]})}):t.jsxs("div",{className:"mb-8 p-4 bg-white/5 rounded-lg border border-white/10 text-center",children:[t.jsx("p",{className:"text-gray-300 mb-4",children:"Vui lòng đăng nhập để bình luận"}),t.jsx("a",{href:"/dang-nhap",className:"inline-block px-6 py-2 bg-sky-400 text-white rounded-lg font-medium hover:bg-sky-500 transition-colors",children:"Đăng nhập"})]}):t.jsx("div",{className:"mb-8 p-4 bg-white/5 rounded-lg border border-white/10 text-center",children:t.jsx("p",{className:"text-gray-400",children:"Đang tải..."})}),r?t.jsx("div",{className:"text-center py-8 text-gray-400",children:"Đang tải bình luận..."}):0===N.length?t.jsx("div",{className:"text-center py-8 text-gray-400",children:"Chưa có bình luận nào. Hãy là người đầu tiên bình luận!"}):t.jsx("div",{className:"space-y-0",children:N.map((e=>t.jsx(j,{comment:e,allComments:s},e.id)))})]})};export{U as default};