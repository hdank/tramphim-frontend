const M={YTPRE2025:{discount:10,type:"percent",description:"Giảm 10%",maxUses:100,expiry:"2025-12-31"},TRAMPHIM:{discount:5,type:"percent",description:"Giảm 5%",maxUses:50,expiry:"2025-12-31"},VNVODICH:{discount:50,type:"percent",description:"Giảm 50%",maxUses:5e5,expiry:"2025-12-31"}},P={SEPHOANG93:{discount:25,type:"percent",description:"Giảm 25%",maxUses:1e4,expiry:"2026-12-31",affiliate:"Garen 93"},DARIUSVP:{discount:20,type:"percent",description:"Giảm 20%",maxUses:5e4,expiry:"2026-12-31",affiliate:"Darius Vĩnh Phúc"},GIANG36:{discount:25,type:"percent",description:"Giảm 25%",maxUses:1e4,expiry:"2026-12-31",affiliate:"Giang 36"}},f={...M,...P},L={bankId:"TCB",accountNumber:"4088880000"},U=4e4;let s=[],A=U,h="";const a=document.getElementById("couponInput1"),l=document.getElementById("couponInput2"),V=document.getElementById("applyCoupon1"),H=document.getElementById("applyCoupon2"),x=document.getElementById("coupon1Status"),C=document.getElementById("coupon2Status"),I=document.getElementById("appliedCouponsContainer"),F=document.getElementById("appliedCouponsList"),_=document.getElementById("availableCouponsList"),E=document.getElementById("originalPrice"),d=document.getElementById("discountRow"),z=document.getElementById("discountAmount"),v=document.getElementById("finalPrice"),u=document.getElementById("dynamicQR"),q=document.getElementById("qrAmount"),Q=document.getElementById("transferContent"),B=document.getElementById("uploadForm"),S=document.getElementById("file-upload");document.getElementById("dropZone");const T=document.getElementById("previewContainer"),Y=document.getElementById("previewImage"),p=document.getElementById("submitBtn"),D="https://api.tramphim.com",R=document.getElementById("notificationModal"),K=document.getElementById("modalTitle"),Z=document.getElementById("modalMessage"),m=document.getElementById("modalIcon"),J=document.getElementById("closeModalBtn");function w(e){return e.toLocaleString("vi-VN")+"đ"}function k(e,t,n){e.classList.remove("hidden","text-green-400","text-red-400","text-yellow-400"),e.classList.add("success"===n?"text-green-400":"error"===n?"text-red-400":"text-yellow-400"),e.textContent=t}function b(e){e.classList.add("hidden")}function $(e){return P.hasOwnProperty(e.toUpperCase().trim())}function W(){return s.some((e=>$(e)))}function X(e){const t=e.toUpperCase().trim();if(!t)return{valid:!1,message:"Vui lòng nhập mã giảm giá"};if(!f[t])return{valid:!1,message:"Mã giảm giá không tồn tại"};if(s.includes(t))return{valid:!1,message:"Mã này đã được áp dụng"};if(s.length>=2)return{valid:!1,message:"Chỉ được áp dụng tối đa 2 mã"};if($(t)&&W())return{valid:!1,message:"Chỉ được áp dụng 1 mã giới thiệu"};const n=f[t];return new Date>new Date(n.expiry)?{valid:!1,message:"Mã giảm giá đã hết hạn"}:{valid:!0,code:t,coupon:n}}function G(){let e=0,t=U;return s.forEach((n=>{const o=f[n];if("percent"===o.type){const n=Math.floor(t*o.discount/100);e+=n,t-=n}else"fixed"===o.type&&(e+=o.discount,t-=o.discount)})),t=Math.max(t,0),{totalDiscount:e,finalPrice:t}}function y(e,t){const n=X(e.value.toUpperCase().trim());n.valid?(s.push(n.code),e.value=n.code,e.disabled=!0,k(t,"✅ Áp dụng thành công: "+n.coupon.description,"success"),N(),j(),c()):k(t,"❌ "+n.message,"error")}function ee(e){s=s.filter((t=>t!==e)),s.length<2&&(a.value.toUpperCase()===e&&(a.value="",a.disabled=!1,b(x)),l.value.toUpperCase()===e&&(l.value="",l.disabled=!1,b(C))),N(),j(),c()}function N(){const{totalDiscount:e,finalPrice:t}=G();A=t,e>0?(E.classList.add("line-through"),d.classList.remove("hidden"),d.classList.add("flex"),z.textContent="-"+w(e)):(E.classList.remove("line-through"),d.classList.add("hidden"),d.classList.remove("flex")),v.classList.add("scale-110"),v.textContent=w(t),setTimeout((()=>v.classList.remove("scale-110")),200),q.textContent=w(t)}function j(){0!==s.length?(I.classList.remove("hidden"),F.innerHTML=s.map((e=>`\n                <span class="inline-flex items-center gap-1 px-2 py-1 bg-green-500/20 border border-green-500/30 rounded-full text-green-400 text-xs">\n                    <span class="font-mono font-bold">${e}</span>\n                    <span class="text-green-300">(${f[e].description})</span>\n                    <button onclick="removeCoupon('${e}')" class="ml-1 hover:text-red-400 transition-colors">\n                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">\n                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />\n                        </svg>\n                    </button>\n                </span>\n            `)).join("")):I.classList.add("hidden")}function c(){const{finalPrice:e}=G(),t=s.join(" ");let n="PREMIUM";h&&(n+=` ${h}`),t&&(n+=` ${t}`),Q.textContent=n;const o=encodeURIComponent(n),i=`https://img.vietqr.io/image/${L.bankId}-${L.accountNumber}-compact.png?amount=${e}&addInfo=${o}`;u.style.opacity="0.5",u.src=i,u.onload=()=>{u.style.opacity="1"}}function te(){_.innerHTML=Object.entries(M).map((([e,t])=>`\n                <div class="flex justify-between items-center text-gray-400">\n                    <span class="font-mono text-yellow-400 cursor-pointer hover:text-yellow-300" onclick="copyCode('${e}')" title="Click để copy">${e}</span>\n                    <span>${t.description}</span>\n                </div>\n            `)).join("")}function ne(e){navigator.clipboard.writeText(e);const t=event.target,n=t.textContent;t.textContent="Đã copy!",t.classList.add("text-green-400"),setTimeout((()=>{t.textContent=n,t.classList.remove("text-green-400")}),1e3)}function g(e,t,n="success"){K.textContent=e,Z.textContent=t,"success"===n?(m.className="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-green-900/50 sm:mx-0 sm:h-10 sm:w-10",m.innerHTML='<svg class="h-6 w-6 text-green-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>'):(m.className="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-900/50 sm:mx-0 sm:h-10 sm:w-10",m.innerHTML='<svg class="h-6 w-6 text-red-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>'),R.classList.remove("hidden")}function oe(){R.classList.add("hidden")}function se(e){const t=e.target.files[0];t&&ie(t)}function ie(e){const t=new FileReader;t.onload=function(e){Y.src=e.target.result,T.classList.remove("hidden")},t.readAsDataURL(e)}V.addEventListener("click",(()=>y(a,x))),H.addEventListener("click",(()=>y(l,C))),a.addEventListener("keypress",(e=>{"Enter"===e.key&&(e.preventDefault(),y(a,x))})),l.addEventListener("keypress",(e=>{"Enter"===e.key&&(e.preventDefault(),y(l,C))})),J.addEventListener("click",oe),S.addEventListener("change",se),B.addEventListener("submit",(async e=>{e.preventDefault();const t=S.files[0];if(!t)return void g("Lỗi","Vui lòng chọn ảnh minh chứng chuyển khoản","error");const n=localStorage.getItem("access_token");if(!n)return g("Yêu cầu đăng nhập","Vui lòng đăng nhập để thực hiện chức năng này","error"),void setTimeout((()=>{window.location.href="/dang-nhap"}),2e3);p.disabled=!0,p.innerHTML='<svg class="animate-spin h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Đang gửi...';const o=new FormData;o.append("file",t),o.append("amount",A.toString()),o.append("coupons",s.join(","));try{const e=await fetch(`${D}/api/premium/request`,{method:"POST",headers:{Authorization:`Bearer ${n}`},body:o});if(!e.ok)throw new Error("Gửi yêu cầu thất bại");g("Thành công",(await e.json()).message||"Yêu cầu đã được gửi. Vui lòng chờ 5-10 phút để kích hoạt.","success"),B.reset(),T.classList.add("hidden")}catch(e){console.error("Error:",e),g("Lỗi","Có lỗi xảy ra. Vui lòng thử lại sau.","error")}finally{p.disabled=!1,p.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 mr-2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg> Gửi xác nhận'}})),window.removeCoupon=ee,window.copyCode=ne;const r=document.getElementById("loginReminder");async function re(){const e=localStorage.getItem("access_token");if(!e)return console.log("No token found, user not logged in"),r&&r.classList.remove("hidden"),void c();try{const t=await fetch(`${D}/api/auth/profile/`,{headers:{Authorization:`Bearer ${e}`}});t.ok?(h=(await t.json()).email||"",console.log("User email loaded:",h),r&&r.classList.add("hidden"),c()):(r&&r.classList.remove("hidden"),c())}catch(e){console.error("Failed to fetch user profile:",e),r&&r.classList.remove("hidden"),c()}}te(),re(),c();