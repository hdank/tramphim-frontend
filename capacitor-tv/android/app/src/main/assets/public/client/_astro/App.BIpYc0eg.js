import{j as i}from"./jsx-runtime.D_zvdyIk.js";import{r as m}from"./index.Be8AcK8B.js";import{H as j}from"./hls.CiLLo4G9.js";const _=m.createContext({focusKey:null,setFocusKey:()=>{}});function T({children:e}){const o=m.useRef(null);return m.useEffect(()=>{let s=0;function n(){return Array.from(document.querySelectorAll(".tv-item"))}function l(r){try{r&&r.focus&&r.focus()}catch{}}function f(r){if(!["ArrowUp","ArrowDown","ArrowLeft","ArrowRight","Enter","Backspace"].includes(r.key))return;const t=Date.now();if(r.repeat&&t-s<40)return;if(s=t,r.key==="Enter"){const c=document.activeElement;c&&typeof c.click=="function"&&(r.preventDefault(),c.click());return}if(r.key==="Backspace"){try{window.history&&window.history.length>1&&(r.preventDefault(),window.history.back())}catch{}return}r.preventDefault();const u=document.activeElement,y=n();if(!y.length)return;if(!u||u===document.body||!u.classList||!u.classList.contains("tv-item")){l(y[0]);return}const p=parseInt(u.getAttribute("data-row")||"0",10),a=parseInt(u.getAttribute("data-col")||"0",10);if(r.key==="ArrowLeft"){const c=y.find(d=>parseInt(d.getAttribute("data-row")||"0",10)===p&&parseInt(d.getAttribute("data-col")||"0",10)===a-1);if(c)l(c);else{const d=u.closest(".tv-row");d&&d.scrollBy({left:-320,behavior:"smooth"})}return}if(r.key==="ArrowRight"){const c=y.find(d=>parseInt(d.getAttribute("data-row")||"0",10)===p&&parseInt(d.getAttribute("data-col")||"0",10)===a+1);if(c)l(c);else{const d=u.closest(".tv-row");d&&d.scrollBy({left:320,behavior:"smooth"})}return}if(r.key==="ArrowUp"||r.key==="ArrowDown"){const c=r.key==="ArrowUp"?-1:1,d=p+c,A=y.filter(v=>parseInt(v.getAttribute("data-row")||"0",10)===d);if(A.length===0)return;const S=u.getBoundingClientRect(),R=S.left+S.width/2;let b=null,E=1/0;if(A.forEach(v=>{const k=v.getBoundingClientRect(),x=k.left+k.width/2,I=Math.abs(x-R);I<E&&(E=I,b=v)}),b){l(b);const v=b.closest(".tv-row");if(v){const k=b.getBoundingClientRect(),x=v.getBoundingClientRect();(k.left<x.left||k.right>x.right)&&v.scrollBy({left:k.left-x.left-20,behavior:"smooth"})}}}}function h(){const r=n();if(r.length)try{r[0].tabIndex=0,r[0].focus()}catch{}}return window.addEventListener("keydown",f),setTimeout(h,250),()=>window.removeEventListener("keydown",f)},[]),i.jsx(_.Provider,{value:{},children:i.jsx("div",{ref:o,className:"tv-focus-root",tabIndex:0,children:e})})}const w="https://api.tramphim.com";async function B(){const e=[{key:"themes",url:`${w}/api/phim/chu-de/`,isObject:!0},{key:"moviehots",url:`${w}/api/filter/?page=1&limit=18&sort=luot-xem`},{key:"moviechieuraps",url:`${w}/api/filter/?page=1&limit=24&loai_phim=phim-le&chieu_rap=true`},{key:"movieheros",url:`${w}/api/filter/?page=1&limit=18&sort=moi-cap-nhat`},{key:"movieupdates",url:`${w}/api/filter/?page=1&limit=24&loai_phim=phim-bo&sort=moi-cap-nhat`},{key:"moviephimbos",url:`${w}/api/filter/?page=1&limit=18&loai_phim=phim-bo&sort=ngay-tao`},{key:"moviephimles",url:`${w}/api/filter/?page=1&limit=18&loai_phim=phim-le&sort=ngay-tao`},{key:"movieanimes",url:`${w}/api/filter/?page=1&limit=12&loai_phim=hoat-hinh&quoc_gia=nhat-ban&nam_phat_hanh=2025&sort=ngay-tao`}];try{return(await Promise.all(e.map(async s=>{try{const n=await fetch(s.url);if(!n.ok)throw new Error;return n.json()}catch{return s.isObject?{}:{data:[]}}}))).reduce((s,n,l)=>{const{key:f,isObject:h}=e[l];return s[f]=h?n:n.data||[],s},{})}catch{return Object.fromEntries(e.map(o=>[o.key,o.isObject?{}:[]]))}}function L({movie:e,rowIndex:o,colIndex:s,onPlay:n}){const l=f=>{f.key==="Enter"&&(f.preventDefault(),n&&n(e))};return i.jsxs("button",{className:"tv-item","data-row":o,"data-col":s,onKeyDown:l,onClick:()=>n&&n(e),style:{width:300,height:170,display:"inline-block",marginRight:16,background:"#111",borderRadius:8,overflow:"hidden",textAlign:"left",padding:8,color:"#fff"},children:[i.jsx("img",{src:e.poster_url,alt:e.ten_phim||e.ten_khac,style:{width:"100%",height:120,objectFit:"cover",borderRadius:6},loading:"lazy"}),i.jsx("div",{style:{marginTop:8,fontSize:16,fontWeight:600},children:e.ten_phim}),i.jsx("div",{style:{opacity:.8,fontSize:13},children:e.ten_khac})]})}function C({movies:e=[],rowIndex:o=0,onPlay:s=()=>{}}){return i.jsx("div",{className:"tv-row",role:"list",style:{whiteSpace:"nowrap",overflowX:"auto",paddingBottom:6},children:e.map((n,l)=>i.jsx(L,{movie:n,rowIndex:o,colIndex:l,onPlay:s},n.id||n.slug||l))})}function D({onPlay:e}){const[o,s]=m.useState([]),[n,l]=m.useState(!0),[f,h]=m.useState(null);return m.useEffect(()=>{let r=!0;async function g(){l(!0);try{const t=await B();if(!r)return;const y=[{key:"moviehots",title:"Hot"},{key:"movieheros",title:"New & Updated"},{key:"moviephimles",title:"Movies"},{key:"moviephimbos",title:"Series"},{key:"movieanimes",title:"Anime"}].map(p=>({title:p.title,movies:t[p.key]||[]})).filter(p=>p.movies&&p.movies.length>0);s(y)}catch(t){h(t)}finally{l(!1)}}return g(),()=>{r=!1}},[]),i.jsxs("div",{className:"tv-layout",style:{background:"#000",color:"#fff",minHeight:"100vh",padding:"24px",boxSizing:"border-box"},children:[i.jsx("header",{style:{fontSize:36,fontWeight:700,marginBottom:20},children:"TramPhim TV"}),i.jsxs("main",{children:[n&&i.jsx("div",{style:{opacity:.8},children:"Loading..."}),f&&i.jsx("div",{style:{color:"#f33"},children:"Failed to load content."}),o.map((r,g)=>i.jsxs("section",{"aria-label":r.title,style:{marginBottom:28},children:[i.jsx("h2",{style:{fontSize:22,marginBottom:12},children:r.title}),i.jsx(C,{rowIndex:g,movies:r.movies,onPlay:t=>{const u=t?.stream_url||t?.video_url||t?.file||"";e&&e({src:u,poster:t.poster_url,title:t.ten_phim||t.ten_khac,id:t.id||t.slug})}})]},r.title))]})]})}function H({src:e="",poster:o="",title:s="",id:n="",onClose:l=()=>{}}){const f=m.useRef(null),h=m.useRef(null),[r,g]=m.useState(!1);return m.useEffect(()=>{const t=f.current;if(!t||!e)return;try{const a=`resume:${n||e}`,c=parseFloat(localStorage.getItem(a)||"0");c>2&&(t.currentTime=c)}catch{}if(j.isSupported()&&e){const a=new j({maxBufferLength:30});h.current=a,a.attachMedia(t),a.on(j.Events.MEDIA_ATTACHED,()=>{a.loadSource(e)}),a.on(j.Events.ERROR,(c,d)=>{console.warn("HLS error",d)})}else t.canPlayType("application/vnd.apple.mpegurl"),t.src=e;const u=()=>g(!0),y=()=>g(!1);t.addEventListener("waiting",u),t.addEventListener("playing",y);const p=setInterval(()=>{try{const a=`resume:${n||e}`;localStorage.setItem(a,String(t.currentTime||0))}catch{}},2e3);return"mediaSession"in navigator&&(navigator.mediaSession.metadata=new window.MediaMetadata({title:s||"TramPhim",artist:"TramPhim",artwork:o?[{src:o,sizes:"512x512",type:"image/png"}]:[]}),navigator.mediaSession.setActionHandler("play",()=>t.play().catch(()=>{})),navigator.mediaSession.setActionHandler("pause",()=>t.pause()),navigator.mediaSession.setActionHandler("seekbackward",a=>{t.currentTime=Math.max(0,t.currentTime-(a.seekOffset||10))}),navigator.mediaSession.setActionHandler("seekforward",a=>{t.currentTime=Math.min(t.duration||1/0,t.currentTime+(a.seekOffset||10))}),navigator.mediaSession.setActionHandler("stop",()=>{t.pause(),t.currentTime=0})),()=>{clearInterval(p),t.removeEventListener("waiting",u),t.removeEventListener("playing",y),h.current&&(h.current.destroy(),h.current=null)}},[e,n,s,o]),i.jsx("div",{className:"tv-player-overlay",style:{position:"fixed",inset:0,background:"rgba(0,0,0,0.85)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:9999},children:i.jsxs("div",{style:{width:"80%",maxWidth:1280,position:"relative"},children:[i.jsx("button",{onClick:()=>{try{f.current.pause()}catch{}l()},style:{position:"absolute",right:8,top:8,zIndex:10,fontSize:18,padding:"8px 12px"},children:"Close"}),i.jsx("video",{ref:f,controls:!0,poster:o,style:{width:"100%",background:"#000",borderRadius:8}}),r&&i.jsx("div",{style:{position:"absolute",left:"50%",top:"50%",transform:"translate(-50%,-50%)",color:"#fff"},children:"Buffering..."})]})})}function F(){const[e,o]=m.useState(null);return i.jsxs(T,{children:[i.jsx(D,{onPlay:s=>o(s)}),e&&i.jsx(H,{src:e.src,poster:e.poster,title:e.title,id:e.id,onClose:()=>o(null)},e.id||e.src)]})}export{F as default};
